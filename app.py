import streamlit as st
import os
import tempfile
from git import Repo
from utils.clustering_comments_dbscan import *  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥—É–ª—å –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏
from utils.search_notebooks import *  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø–æ–∏—Å–∫–∞ –ø–æ –Ω–æ—É—Ç–±—É–∫–∞–º

st.title("–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —Ç–∞–±–ª–∏—Ü")
# –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –Ω–∞ –≤–∫–ª–∞–¥–∫–∏
tab1, tab2 = st.tabs(["–ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤", "–ü–æ–∏—Å–∫ –ø–æ –Ω–æ—É—Ç–±—É–∫–∞–º"])

# --- –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ ---
with tab1:
    # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ 
    st.write("–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤! üëãüèª")
    st.write("üìÑ –î–ª—è –Ω–∞—á–∞–ª–∞ —Å–∫–∞—á–∞–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ Excel (.xlsx) –Ω–∞ Google –î–∏—Å–∫–µ.")
    st.write("‚¨áÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç–µ –µ–µ –ø–æ –∫–Ω–æ–ø–∫–µ –Ω–∏–∂–µ, –∏ —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–¥–µ–ª–∏—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –Ω–∞ –∫–ª–∞—Å—Ç–µ—Ä—ã.")
    uploaded_file = st.file_uploader("–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∞–±–ª–∏—Ü", type=['xlsx'],accept_multiple_files=False,key="fileUploader")

    if uploaded_file is not None:
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª –Ω–∞ –¥–∏—Å–∫
        with open(f"./temp/{uploaded_file.name}", "wb") as f:
            f.write(uploaded_file.getbuffer())
        
        # –ü–æ–ª—É—á–∞–µ–º –ø—É—Ç—å –∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–º—É —Ñ–∞–π–ª—É
        file_path = f"./temp/{uploaded_file.name}"
        clustered_data = main(file_path, "–°—Ç—É–¥–µ–Ω—Ç", "–ü—Ä–æ–≤–µ—Ä—è—é—â–∏–π", "–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π", "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è –≤–µ—Ä–Ω—É–ª–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        if clustered_data is not None:
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏
            def highlight_tasks_and_clusters(val):
                # –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç '---', –≤—ã–¥–µ–ª—è–µ–º –µ–≥–æ –∫–∞–∫ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
                if '---' in str(val):
                    return 'background-color: #ccffcc;'  # –°–≤–µ—Ç–ª–æ-–∑–µ–ª—ë–Ω—ã–π —Ñ–æ–Ω
                # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω—é—é –ø—Ä–æ–≤–µ—Ä–∫—É –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
                return ""  # –û—Å—Ç–∞–≤–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —è—á–µ–π–∫–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
            styled_data = clustered_data.style.map(highlight_tasks_and_clusters)

            # –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏–∑–∞—Ü–∏—é
            styled_data = clustered_data.style.applymap(highlight_tasks_and_clusters)

            # –ü—Ä–∏–º–µ–Ω—è–µ–º –∞–≤—Ç–æ—à–∏—Ä–∏–Ω—É –∫ —Å—Ç–æ–ª–±—Ü–∞–º
            col_widths = {
                col: max(clustered_data[col].astype(str).map(len).max(), len(col)) + 5
                for col in clustered_data.columns
            }
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É —Å—Ç–æ–ª–±—Ü–æ–≤
            for col, width in col_widths.items():
                styled_data.set_properties(subset=[col], **{'width': f'{width}ch'})

            st.write("–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏:")
            st.table(styled_data)
            
            # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º DataFrame —Å –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–µ–π
        else:
            st.write("–û—à–∏–±–∫–∞: –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ –≤–µ—Ä–Ω—É–ª–∞ –¥–∞–Ω–Ω—ã—Ö.")

# --- –ü–æ–∏—Å–∫ –ø–æ –Ω–æ—É—Ç–±—É–∫–∞–º ---
with tab2:
    st.write("–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞ —Å–ª–æ–≤ –ø–æ Jupyter –Ω–æ—É—Ç–±—É–∫–∞–º üìÇ")
    st.write("–ù–∞ –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫–µ —Å–∫–∞—á–∞–π –ø–∞–ø–∫–∏ —Å –Ω–æ—É—Ç–±—É–∫–∞–º–∏.")
    # –í–≤–æ–¥ –ø—É—Ç–∏ –∫ –ø–∞–ø–∫–µ –∏ —Å–ª–æ–≤–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤
    # –í–≤–æ–¥ –ø—É—Ç–∏ –∫ –ø–∞–ø–∫–µ
    # –í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
    repo_url = st.text_input("–í–≤–µ–¥–∏—Ç–µ URL Git-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è —Å –Ω–æ—É—Ç–±—É–∫–∞–º–∏")
    token = st.text_input("–í–≤–µ–¥–∏—Ç–µ GitHub —Ç–æ–∫–µ–Ω (–¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è)", type="password")
    search_word = st.text_input("–í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ –¥–ª—è –ø–æ–∏—Å–∫–∞", "")

    if st.button("–ò—Å–∫–∞—Ç—å"):
        if repo_url and token and search_word:
            # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
            temp_folder = tempfile.mkdtemp()
            repo_folder = os.path.join(temp_folder, "repo")

            try:
                # –§–æ—Ä–º–∏—Ä—É–µ–º URL —Å —Ç–æ–∫–µ–Ω–æ–º –¥–ª—è –¥–æ—Å—Ç—É–ø–∞
                auth_repo_url = repo_url.replace("https://", f"https://{token}@")
                
                # –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
                Repo.clone_from(auth_repo_url, repo_folder)
                st.write(f"–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –≤ –ø–∞–ø–∫—É: {repo_folder}")

                # –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–∏—Å–∫ —Å–ª–æ–≤–∞ –≤ –Ω–æ—É—Ç–±—É–∫–∞—Ö
                results = search_in_notebooks(repo_folder, search_word)
                
                if results:
                    st.write("–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞:")
                    for result in results:
                        st.write(result)
                else:
                    st.write("–°–æ–≤–ø–∞–¥–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.")
            except Exception as e:
                st.write(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è: {e}")
        else:
            st.warning("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ URL —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è, —Ç–æ–∫–µ–Ω –∏ —Å–ª–æ–≤–æ –¥–ª—è –ø–æ–∏—Å–∫–∞.")